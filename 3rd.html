<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>points show</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
<style>
body {
  font-family: "Tajawal", sans-serif;
  margin: 0; padding: 0;
  background: linear-gradient(135deg, #74b9ff, #a29bfe, #ffeaa7, #fab1a0);
  background-size: 400% 400%;
  animation: gradientBG 15s ease infinite;
  display: flex; justify-content: center; align-items: center;
  height: 100vh; flex-direction: column;
}
@keyframes gradientBG {
  0% {background-position: 0% 50%;}
  50% {background-position: 100% 50%;}
  100% {background-position: 0% 50%;}
}
#welcome, #pointsPage { display: none; text-align: center; }
h1 { font-size: 2.4em; color: #2d3436; text-shadow: 2px 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
button {
  background: linear-gradient(45deg, #fd79a8, #e84393);
  color: white; border: none;
  padding: 14px 28px; border-radius: 12px; cursor: pointer;
  font-size: 1.2em; transition: transform 0.3s ease, box-shadow 0.3s ease;
}
button:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 15px rgba(0,0,0,0.2);
}
.container {
  background: rgba(255,255,255,0.95);
  padding: 25px 20px;
  border-radius: 20px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.25);
  width: 90%; max-width: 360px;
  box-sizing: border-box;
}
.container > * {
  margin-bottom: 16px;
}
input {
  width: 100%; padding: 14px;
  border: 1px solid #ccc; border-radius: 12px;
  font-size: 1.1em;
  transition: border 0.3s ease, box-shadow 0.3s ease;
  box-sizing: border-box;
}
input:focus {
  border-color: #6c5ce7;
  box-shadow: 0 0 8px rgba(108,92,231,0.5);
  outline: none;
}
.suggestions {
  background: #fff; border-radius: 12px; border: 1px solid #ddd;
  max-height: 150px; overflow-y: auto;
}
.suggestions div {
  padding: 10px; cursor: pointer; transition: background 0.3s ease;
  font-size: 1em;
}
.suggestions div:hover { background: #dfe6e9; }
#result {
  background: #f1f2f6;
  padding: 14px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  font-size: 1.2em;
  color: #2d3436;
  transition: opacity 0.5s ease;
}

#characterBox {
  position: fixed;
  bottom: 15px;
  left: 15px;
  width: 200px;
  height: 200px;
  z-index: 10;
  animation: floatAround 25s linear infinite;
}

#character {
  width: 100%;
  height: 100%;
}
@keyframes floatAround {
  0% { transform: translate(0, 0); }
  25% { transform: translate(50vw, -10vh); }
  50% { transform: translate(30vw, 15vh); }
  75% { transform: translate(10vw, -15vh); }
  100% { transform: translate(0, 0); }
}
</style>
</head>
<body>

<!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ÙŠØ© -->
<div id="welcome">
  <h1>ğŸ¯ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ğŸ¯</h1>
  <button onclick="goToPoints()">Ø´ÙˆÙ Ù†Ù‚Ø§Ø·Ùƒ â­</button>
</div>

<!-- ØµÙØ­Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù‚Ø§Ø· -->
<div id="pointsPage">
  <div class="container">
    <h2>Ø´ÙˆÙ Ù†Ù‚Ø§Ø·Ùƒ â­</h2>
    <input id="nameInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§">
    <div class="suggestions" id="suggestions"></div>
    <button onclick="getPoints()">Ø§Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
    <div id="result"></div>
  </div>
  <!-- Ø´Ø®ØµÙŠØ© ØªÙØ§Ø¹Ù„ÙŠØ© -->
  <div id="characterBox">
    <div id="character"></div>
  </div>
</div>

<script>
const apiURL = "https://3rd-system-grades.johnmamdouh777.workers.dev/?name=";
let allNames = [];
let characterAnim;

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø£ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
window.addEventListener("DOMContentLoaded", () => {
  document.getElementById("welcome").style.display = "block";
  characterAnim = lottie.loadAnimation({
    container: document.getElementById("character"),
    renderer: "svg",
    loop: true,
    autoplay: true,
    path: "https://lottie.host/92f5826a-6158-40d5-9429-0a7de2ab1e2d/jOaZkODiyK.json" // ÙˆÙ„Ø¯ ÙƒØ±ØªÙˆÙ†ÙŠ Ù…Ø¨ØªØ³Ù…
  });
  loadNames();
});

// ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø·ÙØ§Ù„
async function loadNames() {
  const cached = localStorage.getItem("allNames");
  if (cached) {
    allNames = JSON.parse(cached);
    return;
  }
  try {
    const res = await fetch(apiURL + "load_names");
    const data = await res.json();
    if (data.names) {
      allNames = data.names;
      localStorage.setItem("allNames", JSON.stringify(allNames));
    }
  } catch (err) {
    console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡", err);
  }
}

// Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©
const nameInput = document.getElementById("nameInput");
nameInput.addEventListener("input", () => {
  setCharacter("typing");
  const val = nameInput.value.trim();
  const box = document.getElementById("suggestions");
  box.innerHTML = "";
  if (!val) return;
  const matches = allNames.filter(n => n.includes(val)).slice(0,5);
  matches.forEach(name => {
    const div = document.createElement("div");
    div.textContent = name;
    div.onclick = () => { nameInput.value = name; box.innerHTML = ""; };
    box.appendChild(div);
  });
});

// ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©
function setCharacter(state) {
  if (!characterAnim) return;
  let url = "";
  switch(state) {
    case "start":
      url = "https://lottie.host/92f5826a-6158-40d5-9429-0a7de2ab1e2d/jOaZkODiyK.json"; // ÙØ±Ø­Ø§Ù†
      break;
    case "typing":
      url = "https://lottie.host/6f4dcfaf-4b9c-4a84-b5f9-0cb62b518b5e/8CuBD31nBj.json"; // Ø¨ÙŠÙÙƒØ±
      break;
    case "waiting":
      url = "https://lottie.host/ea70c3ee-9376-4a5e-981f-8037db7adbc2/CdbmE8Gtx9.json"; // Ù…Ø³ØªÙ†ÙŠ
      break;
    case "result":
      url = "https://lottie.host/6fdb71e9-d5ed-4a4f-9cda-1b6783e92cb8/9MvlM1FWhu.json"; // Ø¨ÙŠØµÙÙ‚
      break;
    default:
      url = "https://lottie.host/92f5826a-6158-40d5-9429-0a7de2ab1e2d/jOaZkODiyK.json";
  }
  characterAnim.destroy();
  characterAnim = lottie.loadAnimation({
    container: document.getElementById("character"),
    renderer: "svg",
    loop: true,
    autoplay: true,
    path: url
  });
}

// Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø§Ù„Ù†Ù‚Ø§Ø·
function goToPoints() {
  document.getElementById("welcome").style.display = "none";
  document.getElementById("pointsPage").style.display = "block";
  setCharacter("start");
}

// Ø¬Ù„Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·
async function getPoints() {
  setCharacter("waiting");
  const name = nameInput.value.trim();
  const resultBox = document.getElementById("result");
  if (!allNames.includes(name)) {
    resultBox.innerText = "âŒ Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„";
    return;
  }
  const res = await fetch(apiURL + encodeURIComponent(name));
  const data = await res.json();
  if (data.error) {
    resultBox.innerText = data.error;
  } else {
    resultBox.style.opacity = 0;
    setTimeout(() => {
      resultBox.innerHTML = `
        ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${data.name}<br>
        â­ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ÙƒÙ„ÙŠØ©: ${data.total}<br>
        ğŸ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©: ${data.used}<br>
        â– Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø®ØµÙˆÙ…Ø©: ${data.minus}<br>
        ğŸ† <strong>Ø§Ù„Ù…Ø­ØµÙ„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: ${data.final}</strong>
      `;
      resultBox.style.opacity = 1;
      setCharacter("result");
    }, 200);
  }
}
</script>
</body>
</html>
